<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>미미 美;Me - 결제</title>
<style type="text/css">
body{
		font-family: 'Noto Sans KR', sans-serif;
		padding-top: 81px;
	}
.delivery{
	border: 1px solid #333;
	width: 50%;
	background-color: #FAFAFF;
}

.div_pay{
	margin: 20px;
}

#amount{
	border: 1px solid #333;
}

table{
	border: 1px solid #333;
	background-color: #FAFAFF;
}

.th{
	width: 150px;
}

td{font-size: 20px;}

.payment{font-size: 30px;}

.input-name{width: 100px;}
.input-tel{width: 115px;}
.input-addr{width: 350px;}


</style>
<script type="text/javascript" src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script type="text/javascript">
// header, footer include
$(document).ready(function(){
    $("#header").load("/header.html");
    $("#footer").load("/footer.html");
});

let url = location.href;	//url 요청
let getReceive = url.substr(url.indexOf("?")+1)
let getReceiveSplit = getReceive.split("=");
let getArtNo = getReceiveSplit[1];

$(function(){
	$.getScript("/loginCheck.js",function(){
		let payAmount; //결제금액
		let getMemNo=memNo;	//로그인한 회원번호


/*-----------------결제없이 페이지 벗어날 때(판매상태:sale로 변경, 마감시간 5시간 추가) 수정 예정-------------------*/
let checkOk = true;
$(window).on("beforeunload",function(){
	if(checkOk){
		//작품 판매상태를 sale로 변경해준다.
		$.ajax({url:"/updateSale.do",
		type:"post",
		data:{artNo:getArtNo},	//작품번호
		success:function(m){
			console.log("판매상태 sale로 변경");
		}});
		
		//남은시간 5시간 추가
		$.ajax({
		url:"/upTimeFive.do",
		data:{artNo:getArtNo},
		success:function(data){
			alert("페이지를 벗어나 결제가 취소되었습니다.");
		}});
		
		return "페이지를 벗어나면 결제가 취소됩니다.";
	}
});



/*---------------------작품 불러오기 start------------------------*/
	function loadArts(){
		let arr;	//AuctionVo 값 불러올 변수 선언
		$("#arts_list").empty(); //중복 출력 방지
		
		$.ajax({url:"/findInfo.do",
		type:"get",
		data:{artNo:getArtNo},
		success:function(data){
			arr = eval(data);
			$.each(arr, function(index, pay){
			
			//가격에 쉼표 [by 최은혜]
			let aucBidString = (pay.aucBid).toString(); 
			let aucBid = aucBidString.replace(/\B(?<!\.\d*)(?=(\d{3})+(?!\d))/g, ",");
			let aucBuyString = (pay.aucBuy).toString();
			let aucBuy = aucBuyString.replace(/\B(?<!\.\d*)(?=(\d{3})+(?!\d))/g,",");
			
				let tr = $("<tr></tr>");
				let img = $("<td></td>").html($(`<img width="300px" height="200px">`).attr("src","./art_pic/"+pay.artPic));
				let art_no = $("<td></td>").html(pay.artNo);
				let art_name = $("<td></td>").html(pay.artName);
				let auc_buy = $("<td></td>").html(aucBuy);
				let auc_bid = $("<td></td>").html(aucBid);
					
		//입찰 금액은 시작가보다 높아야한다.
		//입찰가가 즉시구매가보다 높으면 즉시구매가로 결제 진행
		//입찰가가 즉시구매가보다 낮으며 입찰 시간이 종료되면 입찰가로 결제 진행
		if(pay.aucBuy<=pay.aucBid){
			payAmount = $("<td></td>").html(aucBuy);
		}else{
			payAmount = $("<td></td>").html(aucBid);
		}
					
		$(tr).append(img,art_name,auc_buy,auc_bid);
		$("#arts_list").append(tr);
		$("#amount").append(payAmount);
	
/*-----------결제하기---------------------*/		
	$("#btnPayOK").click(function(){
		checkOk=false;		//페이지 벗어나도 영향을 안받는다.
						
		 	$("#memNo").val(getMemNo); //로그인한 회원번호를 세션에서 가져온다.
			$(".artNo").val(getArtNo);
			
		let getAmount = Number($("#amount").text().replaceAll(",",""));	//최종 결제금액을 불러온다.
		$(".payAmount").val(getAmount); 
		let data = $("#f").serializeArray();	//회원번호,작품번호,결제금액,결제수단의 값을 불러온다.
					
	//입력한 정보가 있을 경우		
	if(!($("#memName").val()=="" || $("#memTel").val()=="" || $("#memAddr").val() == "")){
				
		//payment_tb, artist_point_tb에 각각 결제정보를 넣어준다. 
		$.ajax({url:"/insertPayment.do",
		type:"post",
		data:data,
		success:function(m){
			if(m != -1){
				console.log("결제되었습니다.");
			}else{
				alert("결제 실패");								
			}
		}});
			
		//포인트_tb에서 판매자가 가지고 있는 포인트+결제금액 update
		$.ajax({url:"/updatePoint.do",
		type:"post",
		data:{memNo:pay.memNo,payAmount:getAmount},
		success:function(m){
			if(m != -1){
				console.log("포인트 입력완료");
			}else{
				console.log("포인트 입력 실패");								
			}
		}});
							
		//판매상태를 sold로 변경
		$.ajax({url:"/updateSold.do",
		type:"post",
		data:{artNo:getArtNo},	//작품번호
		success:function(m){
			if(m != -1){
				alert("결제되었습니다.");
				location.href="purchaselist.html";
			}else{
				alert("판매상태 변경 실패");								
			}
		}});
		
		//최고입찰자 초기화(결제대기에서 안보이게)
		$.ajax({url:"/resetTop.do",
		type:"post",
		data:{artNo:getArtNo},	//작품번호
		success:function(m){
			if(m != -1){
				console.log("최고입찰자 초기화");
			}else{
				alert("판매상태 변경 실패");								
			}
		}});
		
}else{
	alert("입력정보가 비어있습니다!");
}});
});
}});
}
/*----------------------작품 불러오기 end--------------------*/

//로그인한 회원정보 가져오기	
function getMemberInfo(){
	let data = {memNo: getMemNo};
	$.ajax({url:"/getMember.do",
	data:data,
	success:function(mem){
		$("#memNo").val(mem.memNo);	 
		$("#memName").val(mem.memName.trim());	 
		$("#memTel").val(mem.memTel.trim());
		$("#memAddr").val(mem.memAddr.trim());
	}});
}//getMemberInfo
	
		getMemberInfo();	//로그인한 회원정보 가져오기
		loadArts();		//작품정보 불러오기

	});	//getScript
}); 
</script>
</head>
<body>
<header id="header"></header>
<div class="container">
	<div class="delivery m-5">
	<h3>배송지 확인</h3>
	수령인 <input type="text" id="memName" name="memName" class="input-name" maxlength="8"><br>
	휴대전화 <input type="text" id="memTel" name="memTel" class="input-tel" maxlength="11"><br> 
	주소 <input type="text" id="memAddr" name="memAddr" class="input-addr">
	<hr>
	<span class="payment">결제 수단</span>
	<div id="payment">
		<form id="f">
			<input type="hidden" id="memNo" name="memNo">
			<input type="hidden" class="artNo" name="artNo">
			<input type="hidden" class="payAmount" name="payAmount">
			<input type="radio" class="payValue" name="payValue" value="신용카드" checked="checked">신용카드
			<input type="radio" class="payValue" name="payValue" value="카카오페이">카카오페이
			<input type="radio" class="payValue" name="payValue" value="실시간 계좌이체">실시간 계좌이체<br>
			<input type="radio" class="payValue" name="payValue" value="무통장입금">무통장입금
			<input type="radio" class="payValue" name="payValue" value="네이버페이">네이버페이
			<input type="radio" class="payValue" name="payValue" value="휴대전화">휴대전화
		</form>
	</div>	
	</div>
<hr>
<div class="box m-5">
<table>
	<thead>
		<tr>
			<th class="th">작품</th>
			<th class="th">작품명</th>
			<th class="th">즉시구매가</th>
			<th class="th">낙찰가</th>
		</tr>
	</thead>
	<tbody id="arts_list"></tbody>
</table>
	<div class="div_pay">
		<span class="payment">결제금액</span>
		<span id="amount"></span>원
		<button id="btnPayOK" type="submit" class="btn btn-dark">결제하기</button>
	</div>
</div>
</div>
<footer id="footer"></footer>
</body>
</html>